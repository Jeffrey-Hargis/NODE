(function (root, factory) {
	if (typeof define === 'function' && define.amd) {
		define([], factory);
	} else if (typeof module === 'object' && module.exports) {
		module.exports = factory();
	} else {
		root.initSpeedTest = factory();

		// initSpeedtest is deprecated
		root.initSpeedtest = root.initSpeedTest;
	}
}(this, function () {
	function initSpeedTest(options) {
		if (typeof options === 'string') {
			options = { el: options };
		}

		var container;
		if (options.el instanceof HTMLElement) {
			container = options.el;
		} else {
			container = document.querySelector(options.el);

			if (!container) {
				throw new Error('Element for speedtest not found');
			}
		}

		var args = [];

		['primary', 'secondary', 'lang'].forEach(function (prop) {
			if (options[prop]) {
				args.push(prop + '=' + encodeURIComponent(options[prop]));
			}
		});

		var iframeEl = document.createElement('iframe');
		var src = '//speedtest.samknows.com/' + (args.length ? '?' + args.join('?') : '');
		iframeEl.setAttribute('src', src);
		iframeEl.setAttribute('class', 'sk-speedtest');

		var width;
		if (options.width) {
			width = options.width + (typeof options.width === 'string' ? '' : 'px');
		} else {
			width = (container.getBoundingClientRect().width || 400) + 'px';
		}

		var height;
		if (options.height) {
			height = options.height + (typeof options.height === 'string' ? '' : 'px');
		} else {
			height = (container.getBoundingClientRect().height || 700) + 'px';
		}

		iframeEl.style.width = width;
		iframeEl.style.height = height;

		container.appendChild(iframeEl);


		var events = [];

		window.addEventListener('message', function (e) {
			if (/http:\/\/speedtest\.samknows\.com/.test(e.origin)) {
				events.forEach(function (event) {
					if (event[0] === 'complete') {
						event[1](e.data);
					}
				});
			}
		});

		return {
			on: function (msg, cb) {
				events.push([msg, cb]);
			}
		};
	}

	return initSpeedTest;
}));